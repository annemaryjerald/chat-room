<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Chat Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .top-bar {
            background: #323233;
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-bottom: 1px solid #1e1e1e;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            margin-right: 15px;
        }

        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .control-btn.close { background: #ff5f56; }
        .control-btn.minimize { background: #ffbd2e; }
        .control-btn.maximize { background: #27c93f; }

        .file-tab {
            background: #1e1e1e;
            padding: 6px 16px;
            border-right: 1px solid #252526;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .file-icon {
            color: #4ec9b0;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 50px;
            background: #333333;
            border-right: 1px solid #1e1e1e;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }

        .sidebar-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-icon:hover {
            background: #2a2d2e;
        }

        .sidebar-icon.active {
            border-left-color: #007acc;
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff5f56;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .setup-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 25px;
            padding: 20px;
        }

        .setup-title {
            font-size: 24px;
            color: #4ec9b0;
        }

        .setup-input {
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 12px 20px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            width: 300px;
            text-align: center;
        }

        .setup-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .setup-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .setup-btn:hover {
            background: #0098ff;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-container::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
            max-width: 85%;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .avatar-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .avatar-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .avatar-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .avatar-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .avatar-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .message-author {
            color: #4ec9b0;
            font-weight: bold;
        }

        .message-time {
            color: #858585;
            font-size: 11px;
        }

        .message-text {
            background: #2d2d2d;
            padding: 12px 15px;
            border-radius: 6px;
            border-left: 3px solid #007acc;
            line-height: 1.6;
            font-size: 14px;
            color: #d4d4d4;
            word-wrap: break-word;
            position: relative;
        }

        .message-text.deleted {
            background: #3a2d2d;
            border-left-color: #ff5f56;
            font-style: italic;
            color: #858585;
        }

        .message-media {
            margin-top: 8px;
            border-radius: 6px;
            overflow: hidden;
            max-width: 100%;
        }

        .message-media img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-media img:hover {
            transform: scale(1.02);
        }

        .message-media video {
            max-width: 100%;
            max-height: 400px;
            display: block;
            border-radius: 6px;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #3c3c3c;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
        }

        .file-preview-icon {
            font-size: 20px;
        }

        .file-preview-name {
            flex: 1;
            color: #4ec9b0;
        }

        .file-preview-remove {
            background: #ff5f56;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .settings-panel {
            position: fixed;
            right: -350px;
            top: 35px;
            bottom: 22px;
            width: 350px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 18px;
            color: #4ec9b0;
            font-weight: bold;
        }

        .settings-close {
            background: transparent;
            border: none;
            color: #858585;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: #3c3c3c;
            color: #d4d4d4;
        }

        .settings-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section-title {
            color: #007acc;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3e3e42;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
        }

        .setting-name {
            color: #d4d4d4;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .setting-desc {
            color: #858585;
            font-size: 11px;
            line-height: 1.4;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #3c3c3c;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #007acc;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .time-picker {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .time-input {
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            width: 100%;
        }

        .time-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .notification-test-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            margin-top: 10px;
            width: 100%;
            transition: background 0.2s;
        }

        .notification-test-btn:hover {
            background: #0098ff;
        }

        .notification-permission {
            background: #3a2d2d;
            border: 1px solid #ff5f56;
            border-left: 3px solid #ff5f56;
            padding: 12px;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 12px;
            margin-top: 10px;
            line-height: 1.5;
        }

        .message.own .message-text {
            border-left-color: #667eea;
            background: #2a2a3e;
        }

        .message-text:hover .react-btn {
            opacity: 1;
        }

        .react-btn {
            position: absolute;
            top: -12px;
            right: 40px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            border-radius: 12px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }

        .react-btn:hover {
            background: #4a4a4a;
            transform: scale(1.1);
        }

        .delete-btn {
            position: absolute;
            top: -12px;
            right: 10px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            border-radius: 12px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            color: #ff5f56;
        }

        .delete-btn:hover {
            background: #ff5f56;
            color: white;
            transform: scale(1.1);
        }

        .message.own .message-text:hover .delete-btn {
            opacity: 1;
        }

        .reactions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .reaction-item {
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction-item:hover {
            background: #4a4a4a;
            transform: scale(1.05);
        }

        .reaction-item.own-reaction {
            background: #007acc;
            border-color: #0098ff;
        }

        .reaction-count {
            font-size: 11px;
            color: #d4d4d4;
            font-weight: bold;
        }

        .reaction-picker {
            position: absolute;
            background: #2d2d2d;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            top: -160px;
            right: 0;
            max-width: 320px;
            max-height: 150px;
            overflow-y: auto;
        }

        .reaction-picker::-webkit-scrollbar {
            width: 6px;
        }

        .reaction-picker::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .reaction-picker::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 3px;
        }

        .reaction-picker.show {
            display: flex;
        }

        .reaction-option {
            font-size: 20px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .reaction-option:hover {
            background: #3c3c3c;
            transform: scale(1.2);
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 11px;
            color: #858585;
        }

        .read-receipt {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .read-receipt.seen {
            color: #4ec9b0;
        }

        .read-receipt.unseen {
            color: #858585;
        }

        .check-icon {
            font-size: 12px;
        }

        .system-message {
            text-align: center;
            padding: 8px;
            color: #858585;
            font-size: 12px;
            font-style: italic;
        }

        .input-area {
            background: #252526;
            border-top: 1px solid #3e3e42;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .attachment-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background: transparent;
            border: none;
            color: #858585;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .attachment-btn:hover {
            color: #007acc;
            background: #3c3c3c;
        }

        #fileInput {
            display: none;
        }

        #messageInput {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 12px 50px 12px 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            outline: none;
            border-color: #007acc;
        }

        #messageInput::placeholder {
            color: #6a6a6a;
        }

        .send-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            height: 44px;
        }

        .send-btn:hover {
            background: #0098ff;
        }

        .status-bar {
            background: #007acc;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 12px;
            color: white;
        }

        .status-left, .status-right {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: #858585;
        }

        .welcome-icon {
            font-size: 64px;
            opacity: 0.5;
        }

        .welcome-text {
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .info-box {
            background: #2d2d2d;
            border: 1px solid #3e3e42;
            border-left: 3px solid #007acc;
            padding: 15px;
            border-radius: 4px;
            color: #d4d4d4;
            max-width: 500px;
            line-height: 1.6;
        }

        .info-box strong {
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="top-bar">
            <div class="window-controls">
                <button class="control-btn close"></button>
                <button class="control-btn minimize"></button>
                <button class="control-btn maximize"></button>
            </div>
            <div class="file-tab">
                <span class="file-icon">‚óÜ</span>
                <span>private-chat.dev</span>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-icon active" title="Chat">üí¨</div>
                <div class="sidebar-icon" title="Online Users">üë•</div>
                <div class="sidebar-icon" id="settingsBtn" title="Settings" onclick="toggleSettings()">‚öôÔ∏è</div>
            </div>

            <div class="editor-area">
                <div class="setup-screen" id="setupScreen">
                    <div class="welcome-icon">üë®‚Äçüíª</div>
                    <div class="setup-title">// Enter your username</div>
                    <div class="info-box" id="firstTimeInfo">
                        <strong>How this works:</strong><br>
                        Messages are stored in your browser's local storage with <strong>end-to-end encryption</strong>. Both you and your friend need to open this <strong>same URL</strong> and use the <strong>same encryption key</strong> to see each other's messages. The page auto-refreshes every 2 seconds. <strong>Security:</strong> All messages are encrypted - only people with the correct key can read them!
                    </div>
                    <input 
                        type="text" 
                        id="usernameInput" 
                        class="setup-input" 
                        placeholder="username"
                        maxlength="20"
                    >
                    <input 
                        type="password" 
                        id="encryptionKeyInput" 
                        class="setup-input" 
                        placeholder="encryption key (share with friend)"
                        maxlength="50"
                        style="margin-top: 10px;"
                    >
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; color: #d4d4d4; font-size: 13px;">
                        <input type="checkbox" id="rememberMe" style="width: 18px; height: 18px; cursor: pointer;">
                        <label for="rememberMe" style="cursor: pointer;">Remember me on this device</label>
                    </div>
                    <div style="color: #858585; font-size: 12px; max-width: 400px; text-align: center; margin-top: 10px;">
                        üí° Choose a secret key and share it privately with your friend. Both must use the same key to read messages.
                    </div>
                    <button class="setup-btn" onclick="joinChat()">Join Chat</button>
                    <button class="setup-btn" onclick="clearSavedCredentials()" style="background: #3c3c3c; margin-top: 10px; display: none;" id="clearCredsBtn">Clear Saved Login</button>
                </div>

                <div class="chat-container hidden" id="chatContainer">
                    <div class="welcome-screen">
                        <div class="welcome-icon">üí¨</div>
                        <div class="welcome-text">
                            <strong>Chat initialized successfully</strong><br>
                            Waiting for messages...
                        </div>
                    </div>
                </div>

                <div class="input-area hidden" id="inputArea">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="// Type your message here..."
                            rows="1"
                        ></textarea>
                        <button class="attachment-btn" onclick="document.getElementById('fileInput').click()" title="Attach image or video">
                            üìé
                        </button>
                        <input type="file" id="fileInput" accept="image/*,video/*" onchange="handleFileSelect(event)">
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <span>‚ñ∂</span> Send
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <div class="settings-title">‚öôÔ∏è Settings</div>
                <button class="settings-close" onclick="toggleSettings()">‚úï</button>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-section-title">üîî Notifications</div>
                    
                    <div class="setting-item">
                        <div class="setting-label">
                            <div class="setting-name">Desktop Notifications</div>
                            <div class="setting-desc">Get notified when new messages arrive</div>
                        </div>
                        <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div id="notificationPermissionWarning" class="notification-permission hidden">
                        ‚ö†Ô∏è Please allow notifications in your browser to receive alerts when new messages arrive.
                    </div>

                    <button class="notification-test-btn" onclick="testNotification()">Test Notification</button>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">üåô Do Not Disturb</div>
                    
                    <div class="setting-item">
                        <div class="setting-label">
                            <div class="setting-name">Enable DND</div>
                            <div class="setting-desc">Mute all notifications</div>
                        </div>
                        <div class="toggle-switch" id="dndToggle" onclick="toggleDND()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div id="dndModeSettings" class="hidden">
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">DND Mode</div>
                                <div class="setting-desc">Choose when to mute notifications</div>
                            </div>
                        </div>
                        <div style="padding: 0 0 15px 0;">
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#3c3c3c'" onmouseout="this.style.background='transparent'">
                                <input type="radio" name="dndMode" value="forever" id="dndForever" style="width: 16px; height: 16px; cursor: pointer;" onchange="updateDNDMode()">
                                <div>
                                    <div style="color: #d4d4d4; font-size: 14px; margin-bottom: 3px;">Mute Forever</div>
                                    <div style="color: #858585; font-size: 11px;">Disable all notifications indefinitely</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#3c3c3c'" onmouseout="this.style.background='transparent'">
                                <input type="radio" name="dndMode" value="scheduled" id="dndScheduled" checked style="width: 16px; height: 16px; cursor: pointer;" onchange="updateDNDMode()">
                                <div>
                                    <div style="color: #d4d4d4; font-size: 14px; margin-bottom: 3px;">Scheduled</div>
                                    <div style="color: #858585; font-size: 11px;">Mute during specific hours</div>
                                </div>
                            </label>
                        </div>
                        
                        <div id="dndTimeSettings" class="hidden">
                            <div class="setting-item">
                                <div class="setting-label">
                                    <div class="setting-name">DND Time Range</div>
                                    <div class="setting-desc">Set quiet hours</div>
                                </div>
                            </div>
                            <div class="time-picker">
                                <input type="time" id="dndStart" class="time-input" value="22:00" onchange="saveSettings()">
                                <span style="color: #858585;">to</span>
                                <input type="time" id="dndEnd" class="time-input" value="08:00" onchange="saveSettings()">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">üîä Sound</div>
                        
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">Notification Sound</div>
                                <div class="setting-desc">Play sound with notifications</div>
                            </div>
                            <div class="toggle-switch active" id="soundToggle" onclick="toggleSound()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span>‚óÜ</span>
                    <span id="roomInfo">Private Chat</span>
                </div>
                <div class="status-item">
                    <span>üì®</span>
                    <span id="messageCount">0 messages</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item">
                    <span>üë§</span>
                    <span id="currentUser">Not connected</span>
                </div>
                <div class="status-item">
                    <span>üü¢</span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let username = '';
        let roomId = 'default-room';
        let pendingFile = null;
        let lastMessageCount = 0;
        let notificationsEnabled = false;
        let dndEnabled = false;
        let dndMode = 'scheduled'; // 'scheduled' or 'forever'
        let soundEnabled = true;
        let isWindowFocused = true;
        let encryptionKey = '';

        // Encryption functions using AES-256
        async function getEncryptionKey(passphrase) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(passphrase),
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );
            
            return await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode('chat-room-salt-2024'),
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            
            // Combine IV and encrypted data
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(encrypted), iv.length);
            
            // Convert to base64
            return btoa(String.fromCharCode(...combined));
        }

        async function decryptMessage(encryptedText, key) {
            try {
                // Decode from base64
                const combined = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));
                
                // Extract IV and encrypted data
                const iv = combined.slice(0, 12);
                const encrypted = combined.slice(12);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encrypted
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (e) {
                return '[Encrypted - Wrong Key]';
            }
        }

        // Generate unique room ID from URL
        if (window.location.hash) {
            roomId = window.location.hash.substring(1);
        } else {
            roomId = 'room_' + Math.random().toString(36).substring(2, 9);
            window.location.hash = roomId;
        }

        const STORAGE_KEY = 'chat_messages_' + roomId;
        const READ_RECEIPTS_KEY = 'chat_read_receipts_' + roomId;
        const REACTIONS_KEY = 'chat_reactions_' + roomId;
        const SETTINGS_KEY = 'chat_settings_' + roomId;
        const CREDENTIALS_KEY = 'chat_credentials_' + roomId;
        const FIRST_TIME_KEY = 'chat_first_time_' + roomId;

        const REACTION_EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò≠', 'üéâ', 'üî•', 'üíØ', '‚ú®', 'üöÄ', 'üëÄ', 'üí™', 'üôè', 'üëè', 'üòç', 'ü§î', 'üòé', 'ü§©', 'üò±', 'ü•≥', 'üò¥', 'ü§Ø', 'ü•∫', 'üò§', 'ü§ó', 'üôÉ', 'üòè', 'ü§®', 'üò¨', 'ü§´', 'ü§≠', 'ü´°', 'ü•∂', 'ü•µ', 'üòµ', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§†', 'ü§ë', 'ü§ì', 'üòà', 'üëª', 'üíÄ', 'ü§ñ', 'üëΩ', 'üí©', 'üåü', 'üòò', 'üòó', 'üòô', 'üòö', 'üíã', 'ü´Ç', 'ü§ó', 'üíë', 'üíè'];

        // Check for saved credentials on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedCredentials();
            checkFirstTimeUser();
        });

        function checkFirstTimeUser() {
            const hasVisited = localStorage.getItem(FIRST_TIME_KEY);
            const infoBox = document.getElementById('firstTimeInfo');
            
            if (hasVisited) {
                // Not first time - hide the info box
                infoBox.style.display = 'none';
            } else {
                // First time - show the info box
                infoBox.style.display = 'block';
            }
        }

        function markAsReturningUser() {
            localStorage.setItem(FIRST_TIME_KEY, 'true');
        }

        function loadSavedCredentials() {
            const saved = localStorage.getItem(CREDENTIALS_KEY);
            if (saved) {
                try {
                    const credentials = JSON.parse(saved);
                    document.getElementById('usernameInput').value = credentials.username || '';
                    document.getElementById('encryptionKeyInput').value = credentials.key || '';
                    document.getElementById('rememberMe').checked = true;
                    document.getElementById('clearCredsBtn').style.display = 'block';
                } catch (e) {
                    console.error('Error loading credentials:', e);
                }
            }
        }

        function saveCredentials(username, key) {
            const rememberMe = document.getElementById('rememberMe').checked;
            if (rememberMe) {
                const credentials = {
                    username: username,
                    key: key,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(CREDENTIALS_KEY, JSON.stringify(credentials));
            } else {
                localStorage.removeItem(CREDENTIALS_KEY);
            }
        }

        function clearSavedCredentials() {
            if (confirm('Clear saved username and encryption key?')) {
                localStorage.removeItem(CREDENTIALS_KEY);
                document.getElementById('usernameInput').value = '';
                document.getElementById('encryptionKeyInput').value = '';
                document.getElementById('rememberMe').checked = false;
                document.getElementById('clearCredsBtn').style.display = 'none';
                
                // Show info box again for cleared users
                document.getElementById('firstTimeInfo').style.display = 'block';
                localStorage.removeItem(FIRST_TIME_KEY);
                
                alert('Saved credentials cleared!');
            }
        }

        // Load settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
            notificationsEnabled = settings.notificationsEnabled || false;
            dndEnabled = settings.dndEnabled || false;
            dndMode = settings.dndMode || 'scheduled';
            soundEnabled = settings.soundEnabled !== undefined ? settings.soundEnabled : true;
            
            if (notificationsEnabled) {
                document.getElementById('notificationToggle').classList.add('active');
            }
            if (dndEnabled) {
                document.getElementById('dndToggle').classList.add('active');
                document.getElementById('dndModeSettings').classList.remove('hidden');
            }
            if (soundEnabled) {
                document.getElementById('soundToggle').classList.add('active');
            }
            
            // Set DND mode
            if (dndMode === 'forever') {
                document.getElementById('dndForever').checked = true;
                document.getElementById('dndTimeSettings').classList.add('hidden');
            } else {
                document.getElementById('dndScheduled').checked = true;
                if (dndEnabled) {
                    document.getElementById('dndTimeSettings').classList.remove('hidden');
                }
            }
            
            if (settings.dndStart) document.getElementById('dndStart').value = settings.dndStart;
            if (settings.dndEnd) document.getElementById('dndEnd').value = settings.dndEnd;
        }

        function saveSettings() {
            const settings = {
                notificationsEnabled,
                dndEnabled,
                dndMode,
                soundEnabled,
                dndStart: document.getElementById('dndStart').value,
                dndEnd: document.getElementById('dndEnd').value
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const warning = document.getElementById('notificationPermissionWarning');
            
            if (!notificationsEnabled) {
                if (!("Notification" in window)) {
                    alert("This browser does not support notifications");
                    return;
                }
                
                if (Notification.permission === "default") {
                    const permission = await Notification.requestPermission();
                    if (permission !== "granted") {
                        warning.classList.remove('hidden');
                        return;
                    }
                } else if (Notification.permission === "denied") {
                    warning.classList.remove('hidden');
                    return;
                }
                
                notificationsEnabled = true;
                toggle.classList.add('active');
                warning.classList.add('hidden');
            } else {
                notificationsEnabled = false;
                toggle.classList.remove('active');
            }
            saveSettings();
        }

        function toggleDND() {
            const toggle = document.getElementById('dndToggle');
            const modeSettings = document.getElementById('dndModeSettings');
            
            dndEnabled = !dndEnabled;
            
            if (dndEnabled) {
                toggle.classList.add('active');
                modeSettings.classList.remove('hidden');
                updateDNDMode();
            } else {
                toggle.classList.remove('active');
                modeSettings.classList.add('hidden');
                document.getElementById('dndTimeSettings').classList.add('hidden');
            }
            saveSettings();
        }

        function updateDNDMode() {
            const timeSettings = document.getElementById('dndTimeSettings');
            
            if (document.getElementById('dndForever').checked) {
                dndMode = 'forever';
                timeSettings.classList.add('hidden');
            } else {
                dndMode = 'scheduled';
                timeSettings.classList.remove('hidden');
            }
            saveSettings();
        }

        function toggleSound() {
            const toggle = document.getElementById('soundToggle');
            soundEnabled = !soundEnabled;
            
            if (soundEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            saveSettings();
        }

        function isInDNDPeriod() {
            if (!dndEnabled) return false;
            
            // If DND mode is forever, always return true
            if (dndMode === 'forever') return true;
            
            // Otherwise check scheduled time
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const startTime = document.getElementById('dndStart').value.split(':');
            const endTime = document.getElementById('dndEnd').value.split(':');
            
            const start = parseInt(startTime[0]) * 60 + parseInt(startTime[1]);
            const end = parseInt(endTime[0]) * 60 + parseInt(endTime[1]);
            
            if (start < end) {
                return currentTime >= start && currentTime < end;
            } else {
                return currentTime >= start || currentTime < end;
            }
        }

        function playNotificationSound() {
            if (!soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function showNotification(message) {
            if (!notificationsEnabled || isInDNDPeriod() || isWindowFocused) return;
            
            if (Notification.permission === "granted") {
                // Decrypt message for notification
                (async () => {
                    let notificationBody = message.content;
                    if (message.encrypted) {
                        const cryptoKey = await getEncryptionKey(encryptionKey);
                        notificationBody = await decryptMessage(message.content, cryptoKey);
                    }
                    
                    const notification = new Notification(`${message.author} sent a message`, {
                        body: notificationBody.substring(0, 100),
                        icon: 'üí¨',
                        tag: 'chat-notification',
                        requireInteraction: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    playNotificationSound();
                })();
            }
        }

        function testNotification() {
            if (!("Notification" in window)) {
                alert("This browser does not support notifications");
                return;
            }
            
            if (Notification.permission !== "granted") {
                alert("Please enable notifications first");
                return;
            }
            
            const notification = new Notification("Test Notification", {
                body: "This is how new message notifications will look!",
                icon: 'üí¨'
            });
            
            playNotificationSound();
            
            setTimeout(() => notification.close(), 3000);
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function getAvatarClass(name) {
            const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return `avatar-${(hash % 5) + 1}`;
        }

        function getInitials(name) {
            return name.substring(0, 2).toUpperCase();
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function markMessagesAsRead() {
            if (!username) return;
            
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const readReceipts = JSON.parse(localStorage.getItem(READ_RECEIPTS_KEY) || '{}');
            
            messages.forEach((msg, index) => {
                if (msg.author !== username) {
                    if (!readReceipts[index]) {
                        readReceipts[index] = [];
                    }
                    if (!readReceipts[index].includes(username)) {
                        readReceipts[index].push(username);
                    }
                }
            });
            
            localStorage.setItem(READ_RECEIPTS_KEY, JSON.stringify(readReceipts));
        }

        function getReadStatus(messageIndex, messageAuthor) {
            const readReceipts = JSON.parse(localStorage.getItem(READ_RECEIPTS_KEY) || '{}');
            const readers = readReceipts[messageIndex] || [];
            const otherReaders = readers.filter(r => r !== messageAuthor);
            
            if (otherReaders.length === 0) {
                return { seen: false, text: 'Sent' };
            } else if (otherReaders.length === 1) {
                return { seen: true, text: `Seen by ${otherReaders[0]}` };
            } else {
                return { seen: true, text: `Seen by ${otherReaders.length} people` };
            }
        }

        function deleteMessage(messageIndex) {
            if (!confirm('Delete this message? This action cannot be undone.')) {
                return;
            }

            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            if (messages[messageIndex] && messages[messageIndex].author === username) {
                messages[messageIndex].deleted = true;
                messages[messageIndex].content = 'This message was deleted';
                delete messages[messageIndex].media;
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
                renderMessages();
            }
        }

        function toggleReaction(messageIndex, emoji) {
            const reactions = JSON.parse(localStorage.getItem(REACTIONS_KEY) || '{}');
            
            if (!reactions[messageIndex]) {
                reactions[messageIndex] = {};
            }
            
            if (!reactions[messageIndex][emoji]) {
                reactions[messageIndex][emoji] = [];
            }
            
            const userIndex = reactions[messageIndex][emoji].indexOf(username);
            if (userIndex > -1) {
                reactions[messageIndex][emoji].splice(userIndex, 1);
                if (reactions[messageIndex][emoji].length === 0) {
                    delete reactions[messageIndex][emoji];
                }
            } else {
                reactions[messageIndex][emoji].push(username);
            }
            
            localStorage.setItem(REACTIONS_KEY, JSON.stringify(reactions));
            renderMessages();
        }

        function showReactionPicker(messageIndex, button) {
            // Hide all other pickers
            document.querySelectorAll('.reaction-picker').forEach(p => p.classList.remove('show'));
            
            const picker = button.nextElementSibling;
            picker.classList.toggle('show');
            
            // Close picker when clicking outside
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!picker.contains(e.target) && e.target !== button) {
                        picker.classList.remove('show');
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 0);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                event.target.value = '';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                alert('Only images and videos are supported');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingFile = {
                    name: file.name,
                    type: file.type,
                    data: e.target.result
                };
                showFilePreview();
            };
            reader.readAsDataURL(file);
        }

        function showFilePreview() {
            const existingPreview = document.querySelector('.file-preview');
            if (existingPreview) existingPreview.remove();

            const preview = document.createElement('div');
            preview.className = 'file-preview';
            preview.innerHTML = `
                <span class="file-preview-icon">${pendingFile.type.startsWith('image/') ? 'üñºÔ∏è' : 'üé¨'}</span>
                <span class="file-preview-name">${pendingFile.name}</span>
                <button class="file-preview-remove" onclick="clearFilePreview()">‚úï</button>
            `;
            
            const inputWrapper = document.querySelector('.input-wrapper');
            inputWrapper.appendChild(preview);
        }

        function clearFilePreview() {
            pendingFile = null;
            document.getElementById('fileInput').value = '';
            const preview = document.querySelector('.file-preview');
            if (preview) preview.remove();
        }

        function joinChat() {
            const input = document.getElementById('usernameInput');
            const keyInput = document.getElementById('encryptionKeyInput');
            const name = input.value.trim();
            const key = keyInput.value.trim();
            
            if (!name) {
                alert('Please enter a username');
                return;
            }

            if (!key) {
                alert('Please enter an encryption key');
                return;
            }

            if (key.length < 6) {
                alert('Encryption key must be at least 6 characters');
                return;
            }

            username = name;
            encryptionKey = key;
            
            console.log('Joining with key:', encryptionKey); // Debug log
            
            // Save credentials if remember me is checked
            saveCredentials(username, encryptionKey);
            
            // Mark user as returning user (not first time anymore)
            markAsReturningUser();
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            document.getElementById('currentUser').textContent = username;
            document.getElementById('roomInfo').textContent = `Room: ${roomId} üîí`;
            
            // Initialize last message count
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            lastMessageCount = messages.length;
            
            // Load settings
            loadSettings();
            
            // Initial render
            renderMessages().then(() => {
                addSystemMessage(`${username} joined the chat`);
                document.getElementById('messageInput').focus();
            });
            
            setInterval(() => {
                loadMessages();
                markMessagesAsRead();
            }, 2000);
            
            markMessagesAsRead();
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chatContainer');
            const welcome = container.querySelector('.welcome-screen');
            if (welcome) welcome.remove();

            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.textContent = `// ${text}`;
            container.appendChild(systemMsg);
            container.scrollTop = container.scrollHeight;
        }

        // escape HTML to avoid XSS from decrypted/plain messages
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // renderMessages is now async so we can decrypt each message before display
        async function renderMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const reactions = JSON.parse(localStorage.getItem(REACTIONS_KEY) || '{}');
            const container = document.getElementById('chatContainer');
            
            container.innerHTML = '';
            
            // derive crypto key once per render if we have an encryptionKey
            let cryptoKey = null;
            if (encryptionKey) {
                try {
                    cryptoKey = await getEncryptionKey(encryptionKey);
                } catch (e) {
                    console.error('Error deriving crypto key:', e);
                    cryptoKey = null;
                }
            }
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-screen">
                        <div class="welcome-icon">üí¨</div>
                        <div class="welcome-text">
                            <strong>Chat initialized</strong><br>
                            Start typing to send a message...
                        </div>
                    </div>
                `;
            } else {
                for (let index = 0; index < messages.length; index++) {
                    const msg = messages[index];
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.author === username ? 'own' : ''}`;
                    
                    const initials = getInitials(msg.author);
                    const avatarClass = getAvatarClass(msg.author);
                    
                    const readStatus = getReadStatus(index, msg.author);
                    const readReceiptHTML = msg.author === username && !msg.deleted ? `
                        <div class="message-footer">
                            <div class="read-receipt ${readStatus.seen ? 'seen' : 'unseen'}">
                                <span class="check-icon">${readStatus.seen ? '‚úì‚úì' : '‚úì'}</span>
                                <span>${readStatus.text}</span>
                            </div>
                        </div>
                    ` : '';

                    // Build media HTML
                    let mediaHTML = '';
                    if (msg.media && !msg.deleted) {
                        if (msg.media.type.startsWith('image/')) {
                            mediaHTML = `
                                <div class="message-media">
                                    <img src="${msg.media.data}" alt="${escapeHtml(msg.media.name)}" onclick="window.open(this.src, '_blank')">
                                </div>
                            `;
                        } else if (msg.media.type.startsWith('video/')) {
                            mediaHTML = `
                                <div class="message-media">
                                    <video controls>
                                        <source src="${msg.media.data}" type="${msg.media.type}">
                                    </video>
                                </div>
                            `;
                        }
                    }

                    // Build reactions HTML
                    let reactionsHTML = '';
                    const msgReactions = reactions[index] || {};
                    if (Object.keys(msgReactions).length > 0 && !msg.deleted) {
                        const reactionItems = Object.entries(msgReactions)
                            .filter(([emoji, users]) => users.length > 0)
                            .map(([emoji, users]) => {
                                const isOwn = users.includes(username);
                                return `
                                    <div class="reaction-item ${isOwn ? 'own-reaction' : ''}" 
                                         onclick="toggleReaction(${index}, '${emoji}')">
                                        <span>${emoji}</span>
                                        <span class="reaction-count">${users.length}</span>
                                    </div>
                                `;
                            }).join('');
                        
                        if (reactionItems) {
                            reactionsHTML = `<div class="reactions-container">${reactionItems}</div>`;
                        }
                    }

                    // Delete button (only for own messages that aren't deleted)
                    const deleteBtn = msg.author === username && !msg.deleted ? 
                        `<button class="delete-btn" onclick="deleteMessage(${index})" title="Delete message">üóëÔ∏è</button>` : '';

                    // React button (not for deleted messages)
                    const reactBtn = !msg.deleted ? 
                        `<button class="react-btn" onclick="showReactionPicker(${index}, this)">+</button>` : '';

                    // Decrypt message content when necessary
                    let displayContent = msg.content;
                    if (msg.deleted) {
                        displayContent = msg.content; // already set to 'This message was deleted'
                    } else if (msg.encrypted) {
                        if (!encryptionKey) {
                            displayContent = '[Encrypted - join with the correct key to view]';
                        } else if (cryptoKey) {
                            displayContent = await decryptMessage(msg.content, cryptoKey);
                        } else {
                            displayContent = '[Encrypted - Wrong Key]';
                        }
                    } else {
                        displayContent = msg.content;
                    }

                    // Escape the decrypted content and preserve line breaks
                    const safeContentHTML = escapeHtml(displayContent).replace(/\n/g, '<br>');

                    messageDiv.innerHTML = `
                        <div class="message-avatar ${avatarClass}">${initials}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${escapeHtml(msg.author)}</span>
                                <span class="message-time">${escapeHtml(msg.time)}</span>
                            </div>
                            <div class="message-text ${msg.deleted ? 'deleted' : ''}">
                                ${safeContentHTML}
                                ${reactBtn}
                                ${deleteBtn}
                                ${!msg.deleted ? `<div class="reaction-picker">
                                    ${REACTION_EMOJIS.map(emoji => 
                                        `<span class="reaction-option" onclick="toggleReaction(${index}, '${emoji}')">${emoji}</span>`
                                    ).join('')}
                                </div>` : ''}
                            </div>
                            ${mediaHTML}
                            ${reactionsHTML}
                            ${readReceiptHTML}
                        </div>
                    `;
                    
                    container.appendChild(messageDiv);
                }
            }
            
            container.scrollTop = container.scrollHeight;
            
            document.getElementById('messageCount').textContent = 
                `${messages.length} message${messages.length !== 1 ? 's' : ''}`;
        }

        function loadMessages() {
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // Check for new messages
            if (messages.length > lastMessageCount) {
                const newMessages = messages.slice(lastMessageCount);
                newMessages.forEach(msg => {
                    if (msg.author !== username) {
                        showNotification(msg);
                    }
                });
            }
            
            lastMessageCount = messages.length;
            renderMessages(); // async render; we don't need to await here
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !pendingFile) return;
            
            const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const cryptoKey = await getEncryptionKey(encryptionKey);
            
            const messageText = message || (pendingFile ? `Shared ${pendingFile.type.startsWith('image/') ? 'an image' : 'a video'}` : '');
            const encryptedContent = await encryptMessage(messageText, cryptoKey);
            
            const newMessage = {
                author: username,
                content: encryptedContent,
                encrypted: true,
                time: getCurrentTime(),
                timestamp: Date.now()
            };

            if (pendingFile) {
                newMessage.media = pendingFile;
            }

            messages.push(newMessage);

            if (messages.length > 100) {
                messages.shift();
                const readReceipts = JSON.parse(localStorage.getItem(READ_RECEIPTS_KEY) || '{}');
                const reactions = JSON.parse(localStorage.getItem(REACTIONS_KEY) || '{}');
                
                const newReceipts = {};
                Object.keys(readReceipts).forEach(key => {
                    const newKey = parseInt(key) - 1;
                    if (newKey >= 0) newReceipts[newKey] = readReceipts[key];
                });
                
                const newReactions = {};
                Object.keys(reactions).forEach(key => {
                    const newKey = parseInt(key) - 1;
                    if (newKey >= 0) newReactions[newKey] = reactions[key];
                });
                
                localStorage.setItem(READ_RECEIPTS_KEY, JSON.stringify(newReceipts));
                localStorage.setItem(REACTIONS_KEY, JSON.stringify(newReactions));
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
            
            input.value = '';
            autoResize(input);
            clearFilePreview();
            
            await renderMessages();
        }

        const usernameInput = document.getElementById('usernameInput');
        const keyInput = document.getElementById('encryptionKeyInput');
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                keyInput.focus();
            }
        });

        keyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinChat();
        });

        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            autoResize(this);
        });

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('focus', () => {
            isWindowFocused = true;
            if (username) {
                markMessagesAsRead();
                renderMessages();
            }
        });

        window.addEventListener('blur', () => {
            isWindowFocused = false;
        });

        // Update DND time settings
        document.getElementById('dndStart').addEventListener('change', saveSettings);
        document.getElementById('dndEnd').addEventListener('change', saveSettings);

        console.log('%cüîó Share this URL with your friend:', 'color: #4ec9b0; font-size: 14px; font-weight: bold');
        console.log('%c' + window.location.href, 'color: #007acc; font-size: 12px');
    </script>
</body>
</html>